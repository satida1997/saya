<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  .btn-group button {
    margin: 5px;
    padding: 8px 16px;
    cursor: pointer;
  }
  .btn-active { background-color: #4CAF50; color: white; }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 30px;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
  }
  th {
    background-color: #f3f4f6;
  }
</style>
</head>
<body>

<h2>‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h2>

<div class="btn-group">
  <button id="btn-day" class="btn-active">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</button>
  <button id="btn-month">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
  <button id="btn-year">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</button>
  <button id="btn-toggle-chart">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏á‡∏Å‡∏•‡∏°</button>
</div>

<canvas id="financeChart" width="800" height="400"></canvas>

<h3 style="margin-top: 30px;">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h3>
<table>
  <thead>
    <tr>
      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
      <th>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</th>
      <th>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</th>
    </tr>
  </thead>
  <tbody id="transaction-table"></tbody>
</table>

<script>
  const ctx = document.getElementById('financeChart').getContext('2d');

  let chartType = 'bar';
  let timeScale = 'day';
  let financeChart;
  let sampleData = [];

  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô URL Web App ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (Google Apps Script)
  const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbyIuJYwpbUxCZJbtXguH0uVeXy6ickwTo_KpuHAf5LO-Yttu8HzUj2SbLF7j11Pi101/exec';

  async function fetchSheetData() {
    try {
      const res = await fetch(SHEET_API_URL);
      if (!res.ok) {
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + res.status);
        return;
      }
      const json = await res.json();
      // console.log('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API:', json);
      sampleData = json.map(item => ({
        date: item.date,
        income: parseFloat(item.income) || 0,
        expense: parseFloat(item.expense) || 0
      }));
      renderChart();
      renderTransactionTable();
    } catch (err) {
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      console.error(err);
    }
  }

  function groupData(data, scale) {
    const grouped = {};
    data.forEach(item => {
      const d = new Date(item.date);
      let key = '';
      if (scale === 'day') {
        key = item.date;
      } else if (scale === 'month') {
        key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
      } else if (scale === 'year') {
        key = `${d.getFullYear()}`;
      }
      if (!grouped[key]) {
        grouped[key] = { income: 0, expense: 0 };
      }
      grouped[key].income += item.income;
      grouped[key].expense += item.expense;
    });
    return grouped;
  }

  function prepareChartData(groupedData) {
    const labels = Object.keys(groupedData).sort();
    const incomeData = labels.map(l => groupedData[l].income);
    const expenseData = labels.map(l => groupedData[l].expense);
    return { labels, incomeData, expenseData };
  }

  function renderChart() {
    const groupedData = groupData(sampleData, timeScale);
    const { labels, incomeData, expenseData } = prepareChartData(groupedData);

    if (financeChart) financeChart.destroy();

    if (chartType === 'bar') {
      financeChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö',
              data: incomeData,
              backgroundColor: '#60a5fa',
            },
            {
              label: '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢',
              data: expenseData,
              backgroundColor: '#f87171',
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    } else if (chartType === 'pie') {
      const totalIncome = incomeData.reduce((a,b) => a+b, 0);
      const totalExpense = expenseData.reduce((a,b) => a+b, 0);

      financeChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'],
          datasets: [{
            data: [totalIncome, totalExpense],
            backgroundColor: ['#60a5fa', '#f87171'],
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }
  }

  function renderTransactionTable() {
    const tbody = document.getElementById('transaction-table');
    tbody.innerHTML = '';
    const sortedData = [...sampleData].sort((a, b) => new Date(b.date) - new Date(a.date));

    sortedData.forEach(entry => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${entry.date}</td>
        <td style="color: #3b82f6; font-weight: bold;">${entry.income.toLocaleString()}</td>
        <td style="color: #ef4444; font-weight: bold;">${entry.expense.toLocaleString()}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏•‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  document.getElementById('btn-day').addEventListener('click', () => {
    timeScale = 'day';
    setActiveButton('btn-day');
    renderChart();
  });
  document.getElementById('btn-month').addEventListener('click', () => {
    timeScale = 'month';
    setActiveButton('btn-month');
    renderChart();
  });
  document.getElementById('btn-year').addEventListener('click', () => {
    timeScale = 'year';
    setActiveButton('btn-year');
    renderChart();
  });

  // ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏á‡∏Å‡∏•‡∏°
  document.getElementById('btn-toggle-chart').addEventListener('click', () => {
    chartType = (chartType === 'bar') ? 'pie' : 'bar';
    document.getElementById('btn-toggle-chart').textContent = chartType === 'bar' ? '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏á‡∏Å‡∏•‡∏°' : '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ó‡πà‡∏á';
    renderChart();
  });

  function setActiveButton(id) {
    ['btn-day','btn-month','btn-year'].forEach(bid => {
      document.getElementById(bid).classList.remove('btn-active');
    });
    document.getElementById(id).classList.add('btn-active');
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
  fetchSheetData();
</script>

</body>
</html>
